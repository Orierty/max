# Max.ru Бот волонтёров

Бот для платформы Max.ru, который помогает людям с ограниченными возможностями получить помощь от волонтёров. Основные функции: запрос звонка от волонтёра, преобразование голосовых сообщений в текст, AI-распознавание изображений и описание фотографий волонтёрами. Использует волновую систему уведомлений для эффективного распределения запросов.

---

## Содержание

- [Возможности](#возможности)
- [Технологии](#технологии)
- [1.Установка зависимостей](#установка)
  - [Windows](#windows)
  - [macOS и Linux](#macos-и-linux)
- [Настройка базы данных](#настройка-базы-данных)
- [Конфигурация](#конфигурация)
- [2.Запуск бота](#запуск-бота)
- [Опциональные возможности](#опциональные-возможности)
- [Команды бота](#команды-бота)
- [Структура проекта](#структура-проекта)
- [Архитектура](#архитектура)
- [Разработка](#разработка)
- [Решение проблем](#решение-проблем)

---

## Возможности

### Для нуждающихся

**Запрос звонка от волонтёра**
- Волновая система уведомлений отправляет запрос 15 волонтёрам одновременно
- Автоматическая отправка следующей волны через 30 секунд при отсутствии ответа
- Приоритет отдаётся верифицированным и доверенным волонтёрам

**Преобразование голосовых сообщений в текст**
- Офлайн распознавание речи через Vosk
- Поддержка русского языка
- Не требует интернет-соединения для работы

**AI-распознавание изображений**
- Автоматическое описание фотографий через GigaChat Pro
- Детальное описание содержимого на русском языке
- Облачная обработка без нагрузки на устройство

**Описание фото волонтёром**
- Живой человек описывает содержимое фотографии
- Специально для незрячих пользователей
- Волновая система назначения волонтёров

**Удобная навигация**
- Кнопка "Назад в меню" на всех экранах
- Интуитивный интерфейс
- Защита от случайных двойных нажатий

### Для волонтёров

**Система верификации (4 уровня)**
- Новичок (unverified) — начальный уровень без проверки
- На проверке (pending) — заявка отправлена модератору
- Верифицированный (verified) — проверен модератором по документам
- Доверенный (trusted) — 10+ выполненных запросов с рейтингом выше 4.5

**Статистика и рейтинг**
- Средний рейтинг от 1 до 5 звёзд
- Количество выполненных запросов
- Общее количество отзывов
- История всех звонков

**Теги пользователей**
- Бабушка или дедушка
- Незрячий пользователь
- Плохая камера
- Другие важные особенности для волонтёров

**Описание фотографий**
- Помощь незрячим людям в описании изображений
- Текстовое описание того, что изображено на фото
- Все описания сохраняются в историю

**Система отзывов**
- Оценка от 1 до 5 звёзд после каждого запроса
- Возможность оставить текстовый комментарий
- Автоматический подсчёт среднего рейтинга
- Автоматическая блокировка при рейтинге ниже 3.0 после трёх отзывов

### Для модераторов

**Панель модератора**
- Просмотр всех заявок на верификацию
- Управление жалобами от пользователей
- Статистика по всем волонтёрам системы

**Верификация волонтёров**
- Одобрение заявок после проверки документов
- Отклонение с указанием причины
- Возможность оставить комментарий для волонтёра

**Блокировка волонтёров**
- Ручная блокировка с указанием причины
- Автоматическая блокировка по низкому рейтингу
- Возможность разблокировки

**Обработка жалоб**
- Просмотр всех поступивших жалоб
- Принятие решений по каждой жалобе
- Доступные действия: предупреждение, блокировка или отклонение жалобы

---

## Технологии

- **Backend**: Python 3.10 или выше
- **База данных**: PostgreSQL 12 или выше с connection pooling
- **AI модель**: GigaChat Pro для распознавания изображений
- **Распознавание речи**: Vosk (офлайн, русский язык)
- **Мессенджер**: Max.ru API
- **Библиотеки**:
  - psycopg2 — драйвер для PostgreSQL
  - python-dotenv — управление конфигурацией
  - requests — HTTP запросы к API
  - gigachat — API для работы с GigaChat (опционально)
  - vosk — распознавание речи (опционально)

---

## Установка

### Windows

#### Шаг 1: Установка Python

1. Скачайте Python 3.10 или выше с официального сайта: https://www.python.org/downloads/
2. При установке обязательно отметьте галочку "Add Python to PATH"
3. Проверьте установку командой:
   ```powershell
   python --version
   ```
   Должна отобразиться версия Python 3.10 или выше

#### Шаг 2: Клонирование репозитория

```powershell
cd C:\Users\ВашеИмя\Desktop
git clone https://github.com/Orierty/max
cd max
```

Если Git не установлен, скачайте его с https://git-scm.com/download/win и установите с настройками по умолчанию.

#### Шаг 3: Создание виртуального окружения

```powershell
python -m venv venv
.\venv\Scripts\activate
```

После активации в начале строки появится (venv).

#### Шаг 4: Установка зависимостей

```powershell
python -m pip install --upgrade pip
pip install -r requirements.txt
```

Если возникает ошибка с psycopg2, выполните:
```powershell
pip install psycopg2-binary
```

---

### macOS и Linux

#### Шаг 1: Установка Python

**macOS:**
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
brew install python@3.12
```

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install python3.10 python3.10-venv python3-pip
```

Проверка:
```bash
python3 --version
```

#### Шаг 2: Клонирование репозитория

```bash
cd ~/Desktop
git clone https://github.com/Orierty/max
cd max
```

#### Шаг 3: Виртуальное окружение

```bash
python3 -m venv venv
source venv/bin/activate
```

После активации в начале строки появится (venv).

#### Шаг 4: Установка зависимостей

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

---

## Настройка базы данных

### Вариант 1: PostgreSQL через Docker (рекомендуется)

#### Установка Docker Desktop

**Windows:**
1. Скачайте Docker Desktop с https://www.docker.com/products/docker-desktop/
2. Установите и перезагрузите компьютер
3. Запустите Docker Desktop
4. Дождитесь сообщения "Docker is running"

**macOS:**
```bash
brew install --cask docker
```

**Linux:**
```bash
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
```
После этого выйдите из системы и войдите заново.

#### Запуск PostgreSQL

```bash
docker compose up -d
```

Проверка статуса:
```bash
docker compose ps
```

Вы должны увидеть:
```
NAME                COMMAND                  SERVICE             STATUS
max-postgres-1      "docker-entrypoint.s…"   postgres            running
```

#### Управление контейнером

```bash
# Остановить
docker compose stop

# Запустить снова
docker compose start

# Удалить контейнер и все данные
docker compose down -v
```

---

### Вариант 2: Локальная установка PostgreSQL

#### Windows

1. Скачайте PostgreSQL с https://www.postgresql.org/download/windows/
2. Запустите установщик
3. Настройки:
   - Порт: 5432 (по умолчанию)
   - Пароль: запомните его, он понадобится
4. Установите все компоненты

#### Создание базы данных

**Через pgAdmin (графический интерфейс):**
1. Откройте pgAdmin
2. Подключитесь к серверу (введите пароль)
3. Правой кнопкой на "Databases" → Create → Database
4. Name: max_bot
5. Save

**Через командную строку:**
```bash
# Windows (в PowerShell)
& "C:\Program Files\PostgreSQL\14\bin\psql.exe" -U postgres

# macOS/Linux
sudo -u postgres psql
```

Затем в psql:
```sql
CREATE DATABASE max_bot;
\q
```

#### macOS

```bash
brew install postgresql@14
brew services start postgresql@14
createdb max_bot
```

#### Linux (Ubuntu/Debian)

```bash
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql

# Создать базу данных
sudo -u postgres createdb max_bot

# Установить пароль для postgres
sudo -u postgres psql
postgres=# \password postgres
# Введите пароль
postgres=# \q
```

---

## Конфигурация

### Шаг 1: Создание файла .env

```bash
cp .env.example .env
```

Или создайте файл .env вручную в корне проекта.

### Шаг 2: Заполнение .env

Откройте .env в текстовом редакторе и заполните:

```env
# Обязательные настройки

# Токен бота Max.ru (получить у @BotFather на Max.ru)
MAX_TOKEN=ваш_токен_здесь

# База данных

# Если используете Docker (из docker-compose.yml)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=max_bot
DB_USER=postgres
DB_PASSWORD=postgres

# Если установили PostgreSQL локально
# DB_HOST=localhost
# DB_PORT=5432
# DB_NAME=max_bot
# DB_USER=postgres
# DB_PASSWORD=ваш_пароль_при_установке

# Опциональные возможности

# AI распознавание изображений (по умолчанию выключено)
# Требует API ключ GigaChat
VISION_MODEL_ENABLED=false

# Голосовое управление (по умолчанию выключено)
# Требует дополнительной настройки
VOICE_ENABLED=false
```

### Шаг 3: Получение токена Max.ru

1. Зарегистрируйтесь на https://max.ru
2. Найдите @BotFather в Max.ru
3. Отправьте команду /newbot
4. Следуйте инструкциям
5. Скопируйте полученный токен в .env в поле MAX_TOKEN

### Шаг 4: Инициализация базы данных

Запустите скрипт для создания всех таблиц:

```bash
python init_db.py
```

Вы должны увидеть:
```
создание таблиц...
готово

созданные таблицы:
  - audit_log
  - chat_rooms
  - complaints
  - photo_description_requests
  - requests
  - reviews
  - users
  - verification_requests
  - volunteers
```

Если возникла ошибка:
- Проверьте, запущен ли PostgreSQL
- Проверьте правильность данных в .env
- Убедитесь, что база данных max_bot создана

---

## Запуск бота

### Базовый запуск

```bash
# Убедитесь, что виртуальное окружение активировано
# В начале строки должно быть (venv)

# Windows
python main.py

# macOS/Linux
python3 main.py
```

### Фоновый запуск (Linux/macOS)

```bash
# Запустить в фоне
nohup python3 main.py > bot.log 2>&1 &

# Посмотреть логи
tail -f bot.log

# Остановить
pkill -f main.py
```

## Опциональные возможности

### AI распознавание изображений (GigaChat Pro)

Позволяет автоматически описывать содержимое фотографий с помощью AI от Сбербанка.

#### Требования
- API ключ GigaChat (получить на https://developers.sber.ru/gigachat)
- Интернет-соединение (облачный API)

#### Установка

1. **Установите зависимости:**
   ```bash
   pip install gigachat pillow
   ```

2. **Получите API ключ:**
   - Зарегистрируйтесь на https://developers.sber.ru/gigachat
   - Создайте проект и получите API ключ
   - Скопируйте ключ

3. **Добавьте в .env:**
   ```env
   VISION_MODEL_ENABLED=true
   GIGACHAT_API_KEY=ваш_api_ключ_здесь
   ```

4. **Проверка работы:**
   - Запустите бота: python main.py
   - Нажмите "Изображение → Текст"
   - Отправьте фото
   - Получите AI описание от GigaChat

#### Особенности GigaChat

- Облачная обработка — не требует мощного компьютера
- Качественное описание на русском языке
- Автоматическая конвертация изображений в JPEG
- Безопасность — файлы автоматически удаляются после обработки

---

### Голосовое управление

Позволяет отправлять голосовые команды боту.

#### Требования
- ffmpeg для конвертации аудио
- Vosk модель для распознавания речи (около 45 MB)

#### Установка ffmpeg

**Windows:**
```powershell
# Через winget
winget install ffmpeg

# Или через chocolatey
choco install ffmpeg

# Проверка
ffmpeg -version
```

**macOS:**
```bash
brew install ffmpeg
```

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install ffmpeg
```

#### Установка Vosk (уже скачана)

1. **Установите библиотеки:**
   ```bash
   pip install vosk pydub
   ```

2. **Скачайте русскую модель:**
   - Перейдите на https://alphacephei.com/vosk/models
   - Скачайте vosk-model-small-ru-0.22.zip (около 45 MB)
   - Или используйте команду:
     ```bash
     # Windows (PowerShell)
     Invoke-WebRequest -Uri "https://alphacephei.com/vosk/models/vosk-model-small-ru-0.22.zip" -OutFile "vosk-model-small-ru-0.22.zip"

     # macOS/Linux
     wget https://alphacephei.com/vosk/models/vosk-model-small-ru-0.22.zip
     ```

3. **Распакуйте в папку models:**
   ```bash
   # Создать папку
   mkdir -p models

   # Распаковать
   unzip vosk-model-small-ru-0.22.zip -d models/
   ```

   Структура должна быть:
   ```
   max/
   ├── models/
   │   └── vosk-model-small-ru-0.22/
   │       ├── am/
   │       ├── graph/
   │       ├── conf/
   │       └── ...
   ```

4. **Включите в .env:**
   ```env
   VOICE_ENABLED=true
   ```

5. **Перезапустите бота:**
   ```bash
   python main.py
   ```

---

## Команды бота

### Основные команды

| Команда | Описание |
|---------|----------|
| /start | Начать работу с ботом, регистрация |
| /menu | Показать меню (для нуждающихся/волонтёров/модераторов) |
| /switch | Переключить роль (волонтёр ⇄ нуждающийся) (временно, для тестирования) |
| /moderator | Переключить роль на модератора (временно, для тестирования) |


---

## Структура проекта

```
max/
├── bot/                          # Основной код бота
│   ├── __init__.py
│   ├── config.py                 # Конфигурация (env переменные)
│   │
│   ├── handlers/                 # Обработчики событий
│   │   ├── __init__.py
│   │   ├── messages.py          # Текстовые сообщения
│   │   ├── callbacks.py         # Callback кнопки
│   │   ├── menu.py              # Меню для всех ролей
│   │   ├── requests.py          # Запросы на помощь и жалобы
│   │   ├── image.py             # AI распознавание изображений
│   │   ├── voice.py             # Голосовые команды
│   │   ├── verification.py      # Верификация и описание фото
│   │   ├── moderator.py         # Панель модератора
│   │   └── sos.py               # SOS с геолокацией (закомментировано)
│   │
│   ├── utils/                   # Утилиты
│   │   ├── __init__.py
│   │   ├── max_api.py           # Обёртка Max.ru API
│   │   ├── vision.py            # GigaChat Pro модель
│   │   ├── voice.py             # Vosk распознавание речи
│   │   ├── messaging.py         # Вспомогательные функции для сообщений
│   │   └── debounce.py          # Защита от двойных нажатий
│   │
│   ├── chat_pool_initializer.py # Инициализация чат-пула
│   └── chat_room_manager.py     # Управление групповыми чатами
│
├── db/                          # База данных
│   └── schema.sql               # SQL схема (таблицы, триггеры, индексы)
│
├── models/                      # AI модели (создаётся автоматически)
│   └── vosk-model-small-ru-0.22/ # Vosk модель для голоса (опционально)
│
├── downloads/                   # Временные файлы (создаётся автоматически)
│   ├── image_*.jpg              # Скачанные изображения
│   └── voice_*.ogg              # Скачанные голосовые
│
├── database.py                  # PostgreSQL connection pool
├── init_db.py                   # Скрипт инициализации БД
├── main.py                      # Точка входа (запуск бота)
│
├── requirements.txt             # Python зависимости
├── .env.example                 # Пример конфигурации
├── .env                         # Ваша конфигурация (не в git)
├── .gitignore                   # Игнорируемые файлы
│
├── docker-compose.yml           # Docker PostgreSQL
├── DATABASE.md                  # Документация БД
├── README.md                    # Этот файл
│
└── bot.log                      # Логи бота (создаётся автоматически)
```

---

## Архитектура

### Волновая система уведомлений

Используется для эффективного распределения запросов между волонтёрами.

**Принцип работы:**

1. Пользователь создаёт запрос (например, на звонок)
2. Система выбирает 15 волонтёров с приоритетом: trusted → verified → unverified
3. Исключаются заблокированные и уже уведомлённые в этом запросе
4. Отправляются уведомления всем 15 волонтёрам
5. Если никто не откликнулся за 30 секунд, отправляется следующая волна
6. Процесс повторяется до тех пор, пока кто-то не примет запрос
7. Когда волонтёр принимает запрос, остальным отправляется "Запрос уже принят"

**Применяется для:**
- Запросов на звонок (таблица requests)
- Запросов на описание фото (таблица photo_description_requests)

### Защита от двойных нажатий (Debounce)

Предотвращает случайные повторные нажатия на критичные кнопки.

**Механизм:**
- При первом нажатии кнопка блокируется на 2 секунды
- Повторное нажатие игнорируется с сообщением "Подождите..."
- Защищённые действия:
  - request_call (запрос звонка)
  - image_to_text (AI распознавание)
  - voice_to_text (голосовое распознавание)
  - request_verification (заявка на верификацию)
  - request_photo_description (описание фото)

### Connection Pooling

PostgreSQL пул подключений для оптимизации производительности.

**Параметры:**
- Минимум соединений: 1
- Максимум соединений: 10
- Автоматическое переподключение при потере связи
- Таймаут соединения: 30 секунд

**Преимущества:**
- Быстрые запросы за счёт переиспользования соединений
- Защита от перегрузки БД
- Автовосстановление при сбоях

### Система рейтингов

Автоматический подсчёт и обновление рейтинга волонтёров.

**Формула рейтинга:**
```
weighted_rating = (avg_rating × count + 5.0 × 3) / (count + 3)
```

Это даёт "презумпцию невиновности" — первые отзывы меньше влияют на итоговый рейтинг.

**Автоблокировка:**
- Срабатывает при рейтинге меньше 3.0
- Требуется минимум 3 отзыва
- Причина: "Автоматическая блокировка: рейтинг ниже 3.0"

**Автоповышение до Trusted:**
- 10 или более выполненных запросов
- Рейтинг 4.5 или выше
- Текущий статус: verified

### Автоматические триггеры

1. **Обновление времени завершения** (trigger_update_completion_time)
   - При изменении статуса запроса на "completed"
   - Автоматически устанавливает completion_time

2. **Обновление рейтинга** (trigger_update_volunteer_rating)
   - При добавлении нового отзыва
   - Пересчитывает средний рейтинг волонтёра
   - Проверяет условия автоблокировки

3. **Проверка статуса Trusted** (trigger_check_trusted_status)
   - При обновлении данных волонтёра
   - Автоматически повышает до "trusted" при соблюдении условий

4. **Подсчёт выполненных запросов** (trigger_update_completed_count)
   - При завершении запроса
   - Увеличивает счётчик у волонтёра

### Резервное копирование

**Создание бэкапа:**
```bash
# Через Docker
docker exec max-postgres-1 pg_dump -U postgres max_bot > backup_$(date +%Y%m%d).sql

# Локально
pg_dump -U postgres max_bot > backup_$(date +%Y%m%d).sql
```

**Восстановление:**
```bash
# Через Docker
docker exec -i max-postgres-1 psql -U postgres max_bot < backup_20251114.sql

# Локально
psql -U postgres max_bot < backup_20251114.sql
```

---

## Разработка

### Настройка окружения для разработки

```bash
# Установить дополнительные dev зависимости
pip install pytest black flake8 mypy

# Форматирование кода
black .

# Проверка стиля
flake8 bot/

# Проверка типов
mypy bot/
```

### Логирование

Логи сохраняются в bot.log с уровнем DEBUG.

**Просмотр логов в реальном времени:**

```bash
# Linux/macOS
tail -f bot.log

# Windows (PowerShell)
Get-Content bot.log -Wait
```

**Уровни логирования:**
- DEBUG — детальная информация для отладки
- INFO — общая информация о работе
- WARNING — предупреждения
- ERROR — ошибки, но бот продолжает работу
- CRITICAL — критические ошибки

### Структура обработчиков

Все обработчики находятся в bot/handlers/:

```python
# Пример обработчика callback кнопки
from bot.utils import send_message

def handle_some_callback(chat_id, callback_id):
    """Обработка какого-то callback"""
    # Отправить сообщение
    send_message(chat_id, "Привет!")

    # Ответить на callback
    answer_callback(callback_id)
```

### Добавление новой функции

1. Создать обработчик в bot/handlers/your_handler.py
2. Добавить в меню в bot/handlers/menu.py
3. Зарегистрировать callback в bot/handlers/callbacks.py
4. Обновить документацию в README.md

---

## Решение проблем

### Бот не запускается

**Проблема:** ModuleNotFoundError: No module named 'psycopg2'

**Решение:**
```bash
pip install psycopg2-binary
```

---

**Проблема:** connection to server failed: could not connect to server

**Решение:**
1. Проверьте, запущен ли PostgreSQL:
   ```bash
   # Docker
   docker compose ps

   # Локально (Windows)
   Get-Service postgresql*

   # Локально (Linux)
   sudo systemctl status postgresql
   ```

2. Проверьте данные подключения в .env

---

**Проблема:** FATAL: database "max_bot" does not exist

**Решение:**
```bash
# Создайте базу данных
python init_db.py
```

---

### GigaChat Vision не работает

**Проблема:** Ошибка инициализации GigaChat

**Решение:**
1. Проверьте правильность API ключа в .env
2. Убедитесь, что ключ активен на https://developers.sber.ru/gigachat
3. Проверьте интернет-соединение

---

**Проблема:** Ошибка обработки изображения

**Решение:**
1. Убедитесь, что файл является изображением (JPEG, PNG, WebP)
2. Проверьте размер файла (не более 10 MB)
3. Попробуйте другое изображение

---

### Голосовые команды не распознаются

**Проблема:** FileNotFoundError: Vosk model not found

**Решение:**
1. Проверьте структуру папок:
   ```
   models/
   └── vosk-model-small-ru-0.22/
       ├── am/
       ├── graph/
       └── ...
   ```

2. Убедитесь, что папка называется именно vosk-model-small-ru-0.22

---

**Проблема:** ffmpeg not found

**Решение:**
```bash
# Windows
winget install ffmpeg

# macOS
brew install ffmpeg

# Linux
sudo apt install ffmpeg
```

-