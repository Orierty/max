# Max.ru Бот "мои глаза"

Бот для платформы Max.ru, который помогает людям с ограниченными возможностями получить помощь от волонтёров. Основные функции: запрос звонка от волонтёра, преобразование голосовых сообщений в текст, AI-распознавание изображений и описание фотографий волонтёрами. Использует волновую систему уведомлений для эффективного распределения запросов.

---

## Содержание

- [Возможности](#возможности)
- [Технологии](#технологии)
- [Быстрый старт](#быстрый-старт)
- [Настройка базы данных](#настройка-базы-данных)
- [Конфигурация](#конфигурация)
- [Запуск](#запуск)
- [Опциональные возможности](#опциональные-возможности)
- [Команды бота](#команды-бота)
- [Структура проекта](#структура-проекта)
- [Архитектура](#архитектура)
- [Решение проблем](#решение-проблем)

---

## Возможности

### Для нуждающихся

**Запрос звонка от волонтёра**
- Волновая система уведомлений отправляет запрос 15 волонтёрам одновременно
- Автоматическая отправка следующей волны через 30 секунд при отсутствии ответа
- Приоритет отдаётся верифицированным и доверенным волонтёрам

**Преобразование голосовых сообщений в текст**
- Офлайн распознавание речи через Vosk
- Поддержка русского языка
- Не требует интернет-соединения для работы

**AI-распознавание изображений**
- Автоматическое описание фотографий через GigaChat Pro
- Детальное описание содержимого на русском языке
- Облачная обработка без нагрузки на устройство

**Описание фото волонтёром**
- Живой человек описывает содержимое фотографии
- Специально для незрячих пользователей
- Волновая система назначения волонтёров

**Удобная навигация**
- Кнопка "Назад в меню" на всех экранах
- Интуитивный интерфейс
- Защита от случайных двойных нажатий

### Для волонтёров

**Система верификации (4 уровня)**
- Новичок (unverified) — начальный уровень без проверки
- На проверке (pending) — заявка отправлена модератору
- Верифицированный (verified) — проверен модератором по документам
- Доверенный (trusted) — 10+ выполненных запросов с рейтингом выше 4.5

**Статистика и рейтинг**
- Средний рейтинг от 1 до 5 звёзд
- Количество выполненных запросов
- Общее количество отзывов
- История всех звонков

**Теги пользователей**
- Бабушка или дедушка
- Незрячий пользователь
- Плохая камера
- Другие важные особенности для волонтёров

**Описание фотографий**
- Помощь незрячим людям в описании изображений
- Текстовое описание того, что изображено на фото
- Все описания сохраняются в историю

**Система отзывов**
- Оценка от 1 до 5 звёзд после каждого запроса
- Возможность оставить текстовый комментарий
- Автоматический подсчёт среднего рейтинга
- Автоматическая блокировка при рейтинге ниже 3.0 после трёх отзывов

### Для модераторов

**Панель модератора**
- Просмотр всех заявок на верификацию
- Управление жалобами от пользователей
- Статистика по всем волонтёрам системы

**Верификация волонтёров**
- Одобрение заявок после проверки документов
- Отклонение с указанием причины
- Возможность оставить комментарий для волонтёра

**Блокировка волонтёров**
- Ручная блокировка с указанием причины
- Автоматическая блокировка по низкому рейтингу
- Возможность разблокировки

**Обработка жалоб**
- Просмотр всех поступивших жалоб
- Принятие решений по каждой жалобе
- Доступные действия: предупреждение, блокировка или отклонение жалобы

---

## Технологии

- **Backend**: Python 3.10 или выше
- **База данных**: PostgreSQL 12 или выше с connection pooling
- **AI модель**: GigaChat Pro для распознавания изображений
- **Распознавание речи**: Vosk (офлайн, русский язык)
- **Мессенджер**: Max.ru API
- **Библиотеки**:
  - psycopg2 — драйвер для PostgreSQL
  - python-dotenv — управление конфигурацией
  - requests — HTTP запросы к API
  - gigachat — API для работы с GigaChat (опционально)
  - vosk — распознавание речи (опционально)

---

## Быстрый старт

### Требования
- Python 3.10+
- PostgreSQL 12+ (или Docker)
- Git

### Установка

```bash
# Клонировать репозиторий
git clone https://github.com/Orierty/max
cd max

# Создать виртуальное окружение и активировать
python -m venv venv
source venv/bin/activate  # Linux/macOS
.\venv\Scripts\activate   # Windows

# Установить зависимости
pip install -r requirements.txt
```

---

## Настройка базы данных и запуск

### Вариант 1: Docker

Создайте файл .env.docker и скопируйте туда из .env в него.

Замените значение переменной DB_HOST на postgres.

После этого запустите докер с помощью команды:

```bash
docker compose up -d --build
```

### Вариант 2: Локальная установка PostgreSQL

Установите PostgreSQL и создайте базу данных:

```bash
# Создать базу данных max_bot
createdb max_bot
```

---

## Конфигурация

Создайте файл `.env` или `.env.docker` в корне проекта:

```env
# Обязательные настройки

# Токен бота Max.ru
MAX_TOKEN=ваш_токен_здесь

# База данных

# Если используете Docker (из docker-compose.yml)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=max_bot
DB_USER=postgres
DB_PASSWORD=postgres

# Если установили PostgreSQL локально
# DB_HOST=localhost
# DB_PORT=5432
# DB_NAME=max_bot
# DB_USER=postgres
# DB_PASSWORD=ваш_пароль_при_установке

# Опциональные возможности

# AI распознавание изображений
# Требует API ключ GigaChat
VISION_MODEL_ENABLED=true

# Голосовое управление
# Требует дополнительной настройки
VOICE_ENABLED=true
```

Инициализируйте базу данных:

```bash
python init_db.py
```

---

## Запуск

### Запуск бота локально

```bash
# Запустить бота
python main.py
```

### Запуск бота в докере

Создайте файл .env.docker и скопируйте туда из .env в него.

Замените значение переменной DB_HOST на postgres.

После этого запустите докер с помощью команды:

```bash
docker compose up -d --build
```


## Опциональные возможности

### AI распознавание изображений (GigaChat Pro)

```bash
pip install gigachat pillow
```

Добавьте в `.env`:
```env
VISION_MODEL_ENABLED=true
GIGACHAT_API_KEY=ваш_ключ
```

---

### Голосовое управление

Требуется ffmpeg и модель Vosk:

```bash
# Установить ffmpeg
brew install ffmpeg  # macOS
apt install ffmpeg   # Linux
winget install ffmpeg  # Windows

# Установить зависимости
pip install vosk pydub

# Скачать модель (45 MB)
wget https://alphacephei.com/vosk/models/vosk-model-small-ru-0.22.zip
unzip vosk-model-small-ru-0.22.zip -d models/
```

Добавьте в `.env`:
```env
VOICE_ENABLED=true
```

---

## Команды бота

### Основные команды

| Команда | Описание |
|---------|----------|
| /start | Начать работу с ботом, регистрация |
| /menu | Показать меню (для нуждающихся/волонтёров/модераторов) |
| /switch | Переключить роль (волонтёр ⇄ нуждающийся) (временно, для тестирования) |
| /moderator | Переключить роль на модератора (временно, для тестирования) |


---

## Структура проекта

```
max/
├── bot/                          # Основной код бота
│   ├── __init__.py
│   ├── config.py                 # Конфигурация (env переменные)
│   │
│   ├── handlers/                 # Обработчики событий
│   │   ├── __init__.py
│   │   ├── messages.py          # Текстовые сообщения
│   │   ├── callbacks.py         # Callback кнопки
│   │   ├── menu.py              # Меню для всех ролей
│   │   ├── requests.py          # Запросы на помощь и жалобы
│   │   ├── image.py             # AI распознавание изображений
│   │   ├── voice.py             # Голосовые команды
│   │   ├── verification.py      # Верификация и описание фото
│   │   ├── moderator.py         # Панель модератора
│   │   └── sos.py               # SOS с геолокацией (закомментировано)
│   │
│   ├── utils/                   # Утилиты
│   │   ├── __init__.py
│   │   ├── max_api.py           # Обёртка Max.ru API
│   │   ├── vision.py            # GigaChat Pro модель
│   │   ├── voice.py             # Vosk распознавание речи
│   │   ├── messaging.py         # Вспомогательные функции для сообщений
│   │   └── debounce.py          # Защита от двойных нажатий
│   │
│   ├── chat_pool_initializer.py # Инициализация чат-пула
│   └── chat_room_manager.py     # Управление групповыми чатами
│
├── db/                          # База данных
│   └── schema.sql               # SQL схема (таблицы, триггеры, индексы)
│
├── models/                      # AI модели (создаётся автоматически)
│   └── vosk-model-small-ru-0.22/ # Vosk модель для голоса (опционально)
│
├── downloads/                   # Временные файлы (создаётся автоматически)
│   ├── image_*.jpg              # Скачанные изображения
│   └── voice_*.ogg              # Скачанные голосовые
│
├── database.py                  # PostgreSQL connection pool
├── init_db.py                   # Скрипт инициализации БД
├── main.py                      # Точка входа (запуск бота)
│
├── requirements.txt             # Python зависимости
├── .env.example                 # Пример конфигурации
├── .env                         # Ваша конфигурация (не в git)
├── .gitignore                   # Игнорируемые файлы
│
├── docker-compose.yml           # Docker PostgreSQL
├── DATABASE.md                  # Документация БД
├── README.md                    # Этот файл
│
└── bot.log                      # Логи бота (создаётся автоматически)
```

---

## Архитектура

### Волновая система уведомлений

Используется для эффективного распределения запросов между волонтёрами.

**Принцип работы:**

1. Пользователь создаёт запрос (например, на звонок)
2. Система выбирает 15 волонтёров с приоритетом: trusted → verified → unverified
3. Исключаются заблокированные и уже уведомлённые в этом запросе
4. Отправляются уведомления всем 15 волонтёрам
5. Если никто не откликнулся за 30 секунд, отправляется следующая волна
6. Процесс повторяется до тех пор, пока кто-то не примет запрос
7. Когда волонтёр принимает запрос, остальным отправляется "Запрос уже принят"

**Применяется для:**
- Запросов на звонок (таблица requests)
- Запросов на описание фото (таблица photo_description_requests)

### Защита от двойных нажатий (Debounce)

Предотвращает случайные повторные нажатия на критичные кнопки.

**Механизм:**
- При первом нажатии кнопка блокируется на 2 секунды
- Повторное нажатие игнорируется с сообщением "Подождите..."
- Защищённые действия:
  - request_call (запрос звонка)
  - image_to_text (AI распознавание)
  - voice_to_text (голосовое распознавание)
  - request_verification (заявка на верификацию)
  - request_photo_description (описание фото)

### Connection Pooling

PostgreSQL пул подключений для оптимизации производительности.

**Параметры:**
- Минимум соединений: 1
- Максимум соединений: 10
- Автоматическое переподключение при потере связи
- Таймаут соединения: 30 секунд

**Преимущества:**
- Быстрые запросы за счёт переиспользования соединений
- Защита от перегрузки БД
- Автовосстановление при сбоях

### Система рейтингов

Автоматический подсчёт и обновление рейтинга волонтёров.

**Формула рейтинга:**
```
weighted_rating = (avg_rating × count + 5.0 × 3) / (count + 3)
```

Это даёт "презумпцию невиновности" — первые отзывы меньше влияют на итоговый рейтинг.

**Автоблокировка:**
- Срабатывает при рейтинге меньше 3.0
- Требуется минимум 3 отзыва
- Причина: "Автоматическая блокировка: рейтинг ниже 3.0"

**Автоповышение до Trusted:**
- 10 или более выполненных запросов
- Рейтинг 4.5 или выше
- Текущий статус: verified

### Автоматические триггеры

1. **Обновление времени завершения** (trigger_update_completion_time)
   - При изменении статуса запроса на "completed"
   - Автоматически устанавливает completion_time

2. **Обновление рейтинга** (trigger_update_volunteer_rating)
   - При добавлении нового отзыва
   - Пересчитывает средний рейтинг волонтёра
   - Проверяет условия автоблокировки

3. **Проверка статуса Trusted** (trigger_check_trusted_status)
   - При обновлении данных волонтёра
   - Автоматически повышает до "trusted" при соблюдении условий

4. **Подсчёт выполненных запросов** (trigger_update_completed_count)
   - При завершении запроса
   - Увеличивает счётчик у волонтёра

### Резервное копирование

**Создание бэкапа:**
```bash
# Через Docker
docker exec max-postgres-1 pg_dump -U postgres max_bot > backup_$(date +%Y%m%d).sql

# Локально
pg_dump -U postgres max_bot > backup_$(date +%Y%m%d).sql
```

**Восстановление:**
```bash
# Через Docker
docker exec -i max-postgres-1 psql -U postgres max_bot < backup_20251114.sql

# Локально
psql -U postgres max_bot < backup_20251114.sql
```

---

## Решение проблем

### Частые ошибки

**ModuleNotFoundError: No module named 'psycopg2'**
```bash
pip install psycopg2-binary
```

**connection to server failed**
- Проверьте, запущен ли PostgreSQL: `docker compose ps`
- Проверьте данные в `.env`

**database "max_bot" does not exist**
```bash
python init_db.py
```

**GigaChat: ошибка инициализации**
- Проверьте API ключ в `.env`
- Убедитесь, что ключ активен на developers.sber.ru/gigachat

**Vosk model not found**
- Проверьте структуру: `models/vosk-model-small-ru-0.22/`
- Скачайте модель с alphacephei.com/vosk/models